var d=Object.defineProperty;var i=(r,f)=>{for(var w in f)d(r,w,{get:f[w],enumerable:!0,configurable:!0,set:(S)=>f[w]=()=>S})};var c=(r,f)=>()=>(r&&(f=r(r=0)),f);var k={};i(k,{verify:()=>{{return R}},sign:()=>{{return F}},default:()=>{{return Er}},decode:()=>{{return m}}});async function rr(r,f,w){return await crypto.subtle.importKey("raw",Y(r),f,!0,w)}async function wr(r,f,w){return await crypto.subtle.importKey("jwk",r,f,!0,w)}async function fr(r,f,w){return await crypto.subtle.importKey("spki",J(r),f,!0,w)}async function Sr(r,f,w){return await crypto.subtle.importKey("pkcs8",J(r),f,!0,w)}async function b(r,f,w){if(typeof r==="object")return wr(r,f,w);if(typeof r!=="string")throw new Error("Unsupported key type!");if(r.includes("PUBLIC"))return fr(r,f,w);if(r.includes("PRIVATE"))return Sr(r,f,w);return rr(r,f,w)}async function F(r,f,w="HS256"){if(typeof w==="string")w={algorithm:w};if(w={algorithm:"HS256",header:{typ:"JWT"},...w},!r||typeof r!=="object")throw new Error("payload must be an object");if(!f||typeof f!=="string"&&typeof f!=="object")throw new Error("secret must be a string, a JWK object or a CryptoKey object");if(typeof w.algorithm!=="string")throw new Error("options.algorithm must be a string");const S=j[w.algorithm];if(!S)throw new Error("algorithm not found");if(!r.iat)r.iat=Math.floor(Date.now()/1000);const E=`${G(JSON.stringify({...w.header,alg:w.algorithm}))}.${G(JSON.stringify(r))}`,A=f instanceof CryptoKey?f:await b(f,S,["sign"]),C=await crypto.subtle.sign(S,A,Y(E));return`${E}.${e(C)}`}async function R(r,f,w="HS256"){if(typeof w==="string")w={algorithm:w};if(w={algorithm:"HS256",clockTolerance:0,throwError:!1,...w},typeof r!=="string")throw new Error("token must be a string");if(typeof f!=="string"&&typeof f!=="object")throw new Error("secret must be a string, a JWK object or a CryptoKey object");if(typeof w.algorithm!=="string")throw new Error("options.algorithm must be a string");const S=r.split(".");if(S.length!==3)throw new Error("token must consist of 3 parts");const E=j[w.algorithm];if(!E)throw new Error("algorithm not found");const{header:A,payload:C}=m(r);if(A?.alg!==w.algorithm){if(w.throwError)throw new Error("ALG_MISMATCH");return!1}try{if(!C)throw new Error("PARSE_ERROR");const y=Math.floor(Date.now()/1000);if(C.nbf&&C.nbf>y&&C.nbf-y>(w.clockTolerance??0))throw new Error("NOT_YET_VALID");if(C.exp&&C.exp<=y&&y-C.exp>(w.clockTolerance??0))throw new Error("EXPIRED");const _=f instanceof CryptoKey?f:await b(f,E,["verify"]);return await crypto.subtle.verify(E,_,o(S[2]),Y(`${S[0]}.${S[1]}`))}catch(y){if(w.throwError)throw y;return!1}}var t,q,s,V,Y,e,o,G,J,x,m,j,Er;var O=c(()=>{t=function(r){let f="";for(let w=0;w<r.byteLength;w++)f+=String.fromCharCode(r[w]);return f},q=function(r){let f=new Uint8Array(r.length);for(let w=0;w<r.length;w++)f[w]=r.charCodeAt(w);return f},s=function(r){return btoa(t(new Uint8Array(r)))},V=function(r){return q(atob(r)).buffer},Y=function(r){return q(r)},e=function(r){return s(r).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},o=function(r){return V(r.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,""))},G=function(r){const w=(new TextEncoder()).encode(r),S=String.fromCharCode(...w);return btoa(S).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},J=function(r){return V(r.replace(/-+(BEGIN|END).*/g,"").replace(/\s/g,""))};x=function(r){try{const f=Array.from(atob(r),(S)=>S.charCodeAt(0)),w=new TextDecoder("utf-8").decode(new Uint8Array(f));return JSON.parse(w)}catch{return}};m=function(r){return{header:x(r.split(".")[0].replace(/-/g,"+").replace(/_/g,"/")),payload:x(r.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"))}};if(typeof crypto==="undefined"||!crypto.subtle)throw new Error("SubtleCrypto not supported!");j={ES256:{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}},ES384:{name:"ECDSA",namedCurve:"P-384",hash:{name:"SHA-384"}},ES512:{name:"ECDSA",namedCurve:"P-521",hash:{name:"SHA-512"}},HS256:{name:"HMAC",hash:{name:"SHA-256"}},HS384:{name:"HMAC",hash:{name:"SHA-384"}},HS512:{name:"HMAC",hash:{name:"SHA-512"}},RS256:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},RS384:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}},RS512:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}},Er={sign:F,verify:R,decode:m}});function $(r){switch(typeof r){case"string":return{stringValue:r};case"number":if(Number.isInteger(r))return{integerValue:r};return{doubleValue:r};case"boolean":return{booleanValue:r};case"object":if(Array.isArray(r))return{arrayValue:{values:r.map((f)=>$(f))}};return{mapValue:{fields:Object.keys(r).reduce((f,w)=>({...f,[w]:$(r[w])}),{})}};case null:return{nullValue:null};default:return r}}function Z(r){let f={};for(let w in r)if(r.hasOwnProperty(w)){const S=r[w];f[w]=$(S)}return f}function X(r){let f={};for(let w in r)if(r.hasOwnProperty(w)){const S=r[w];if(S.arrayValue)f[w]=S.arrayValue?.values?.map((E)=>{if(E.mapValue)return X(E.mapValue.fields);else return W(E)});else if(S.mapValue)f[w]=X(S?.mapValue?.fields||{});else f[w]=W(S)}return f}function W(r){for(let f in r)if(r.hasOwnProperty(f)){const w=r[f];switch(f){case"stringValue":return w;case"integerValue":return Number(w);case"booleanValue":return w;case"nullValue":return null;default:return w}}}function T(r){const f=r?.name?r?.name?.split("/").pop():void 0,w=r?.fields;try{return{id:f,...X(w)}}catch(S){return console.log("error in formatValuesWithType: ",S),{}}}function H(r){const f=process.env;return{Authorization:"Bearer "+f.FIREBASE_REST_ACCESS_TOKEN,"x-goog-request-params":`project_id=${f.FIREBASE_REST_PROJECT_ID}&database_id=${f.FIREBASE_REST_DATABASE_ID||r||"(default)"}`}}function M(r){if(r.length>=2&&r.startsWith("/")&&r.endsWith("/"))return r.substring(1,r.length-1);return r}function I(r){switch(r){case"==":return"EQUAL";case">":return"GREATER_THAN";case">=":return"GREATER_THAN_OR_EQUAL";case"<":return"LESS_THAN";case"<=":return"LESS_THAN_OR_EQUAL";case"array-contains":return"ARRAY_CONTAINS";case"in":return"IN";case"array-contains-any":return"ARRAY_CONTAINS_ANY";case"!=":return"NOT_EQUAL";case"not-in":return"NOT_IN";default:throw new Error(`Invalid WhereFilterOp: ${r}`)}}function Q(r){switch(r){case"asc":return"ASCENDING";case"desc":return"DESCENDING";default:throw new Error(`Invalid OrderByDirection: ${r}`)}}async function z(){try{const r={...process.env},f=await fetch(`https://firestore.googleapis.com/v1beta1/projects/${r.FIREBASE_REST_PROJECT_ID}/databases/${r.FIREBASE_REST_DATABASE_ID}/documents/test/test`,{method:"GET",headers:H()});if(f.status===401||f.status===403)return console.error("Invalid service account credentials"),!1;else return!0}catch(r){return console.error("Error has occured init fireabse.."),!1}}async function Cr(r){const{sign:f}=await Promise.resolve().then(() => (O(),k)),w=r?.serviceAccount||JSON.parse(process.env.GCLOUD_SERVICE_ACCOUNT||"{}");if(!w)throw new Error("SERVICE_ACCOUNT not found in environment variables");const S=w.private_key;return await f({iss:w.client_email,sub:w.client_email,aud:`https://${r?.service||"firestore"}.googleapis.com/`,iat:Math.floor(Date.now()/1000),exp:Math.floor(Date.now()/1000)+3600},S,{algorithm:"RS256",header:{kid:w.private_key_id||".",typ:"JWT",alg:"RS256"}})}async function h(r){if(r={serviceAccount:{client_email:process.env.FAR_CLIENT_EMAIL||r?.serviceAccount?.client_email||"",project_id:process.env.FAR_PROJECT_ID||r?.serviceAccount?.project_id||"",private_key:process.env.FAR_PRIVATE_KEY||r?.serviceAccount?.private_key||""}},!r.serviceAccount?.project_id)throw new Error("project_id, client_email, private_key are required in serviceAccount.");if(!r.serviceAccount?.client_email)throw new Error("project_id, client_email, private_key are required in serviceAccount.");if(!r.serviceAccount?.private_key)throw new Error("project_id, client_email, private_key are required in serviceAccount.");const f=await Cr({serviceAccount:r.serviceAccount});if(process.env.FIREBASE_REST_ACCESS_TOKEN=f,process.env.FIREBASE_REST_PROJECT_ID=r.serviceAccount.project_id,process.env.FIREBASE_REST_DATABASE_ID=r.databaseId||"(default)",!await z())throw new Error("Service account auth failed, please check the service account credentials.");return{databaseId:r.databaseId||"(default)",serviceAccount:r.serviceAccount,accessToken:f}}async function D(r,f){const w=process.env,S=f?.db||w.FIREBASE_REST_DATABASE_ID;try{const E=await fetch(`https://firestore.googleapis.com/v1beta1/projects/${w.FIREBASE_REST_PROJECT_ID}/databases/${S}/documents/${r}`,{method:"GET",headers:H(S)}).then((A)=>A.json());if(E.error)throw new Error(E.error.message);if(E?.fields)return{id:r.includes("/")?r.split("/").pop()||r:r,ref:r,exists:()=>!0,data:()=>T(E),jsonResponse:E};else return{id:r.includes("/")?r.split("/").pop()||r:r,ref:r,exists:()=>!1,data:()=>{return},jsonResponse:E}}catch(E){throw console.error(E),new Error("Error fetching document from Firestore: ")}}async function U(r,f){const w=process.env,S=f?.page?(f.page-1)*(f.limit||20):0;let E=r.includes("/")?r.split("/"):[],A=E.length?E.pop():r;const C=E?.length?E.join("/"):"",y=C?`${C}/${A}`:A;let _={structuredQuery:{from:[{collectionId:A}],limit:f?.limit||100}};for(let K of f?.where||[])_.structuredQuery.where={compositeFilter:{op:"AND",filters:[..._?.structuredQuery?.where?.compositeFilter?.filters||[],{fieldFilter:{field:{fieldPath:K.field},op:K.op,value:$(K.value)}}]}};if(f?.orderBy&&f?.orderBy.field)_.structuredQuery.orderBy=[{field:{fieldPath:f.orderBy.field},direction:f.orderBy.direction}];if(S)_.structuredQuery.offset=S;const g=await fetch(`https://firestore.googleapis.com/v1beta1/projects/${w.FIREBASE_REST_PROJECT_ID}/databases/${w.FIREBASE_REST_DATABASE_ID}/documents${C?`/${C}`:""}:runQuery`,{method:"POST",headers:H(),body:JSON.stringify(_)}).then((K)=>K.json()).catch((K)=>{throw new Error("Error fetching in querying documents from Firestore: ",K)});if(g.error||g[0]?.error)throw console.error(JSON.stringify(g[0].error)),new Error("Error in querying documents from Firestore:");if(g.length>0){const K=g.map((B)=>{return T(B?.document)}).filter((B)=>B.id);return{size:K.length,empty:K.length===0,docs:K.map((B)=>({id:B.id,ref:y,exists:()=>!0,data:()=>B})),jsonResponse:g}}else return{size:0,empty:!0,docs:[],jsonResponse:g}}async function L(r,f,w){const S=process.env,E=w?.db||S.FIREBASE_REST_DATABASE_ID;r=M(r);const A=r?.includes("/")?r.split("/").pop()||r:r,C=Z(f),y=w?.merge?`?${Object.keys(f).map((g,K)=>(K!==0?"&":"")+`updateMask.fieldPaths=${g}`).join("")}`:"",_=await fetch(`https://firestore.googleapis.com/v1beta1/projects/${S.FIREBASE_REST_PROJECT_ID}/databases/${E}/documents/${r}${y}`,{method:"PATCH",headers:H(E),body:JSON.stringify({fields:C})});if(_.status!==200)throw new Error(`Non 200 status req, error setting/updating document ${r} in Firestore `,_);return{id:A,exists:()=>!0,ref:r,data:()=>f,response:_}}async function v(r,f){const w=process.env,S=f?.db||w.FIREBASE_REST_DATABASE_ID;try{return{response:await fetch(`https://firestore.googleapis.com/v1beta1/projects/${w.FIREBASE_REST_PROJECT_ID}/databases/${S}/documents/${r}`,{method:"DELETE",headers:H(S)})}}catch(E){return{error:E}}}var Ar=function(r,f=950000){const w=[];for(let S=0;S<r.length;S+=f)w.push(r.slice(S,S+f));return w};async function u(r,f){try{const w=await U(r,{orderBy:{field:"index",direction:"ASCENDING"},db:f?.db}).then((C)=>{const y=C.docs.sort((_,g)=>{const K=Number(_.id.split("_").pop()),B=Number(g.id.split("_").pop());return K-B});return{...C,docs:y}}),S=w.docs.map((C)=>C?.data()?.JSON_STRING||"").join(""),E=JSON.parse(S||"[]");if(!Array.isArray(E))throw new Error(`JSON payload in collection ${r} is corrupt, a collection using the DJ engine can't be used to store anything else but its own document data.`);const A=JSON.parse(S||"[]").map((C,y)=>{return{id:`JSON_STRING_${y}`,data:()=>C,exists:!0}});return{size:A?.length||0,empty:A?.length?!1:!0,docReads:w?.size||0,docs:A,jsonResponse:w.jsonResponse}}catch(w){return console.error("!! error in docs to json",w),{size:0,empty:!0,docs:[],error:w,docReads:0}}}async function P(r,f,w){try{const E=JSON.stringify(f),A=Ar(E,950000),C=A.map((y,_)=>{return L(`${r}/JSON_STRING_${_}`,{JSON_STRING:y,lastDoc:A?.length||0,index:_},{db:w?.db,merge:!0})});return await Promise.allSettled(C),{success:!0,message:`Successfully written ${f.length} docs in ${r}`}}catch(S){return console.error("error in json to docs",S),{success:!1,error:S}}}async function a(r,f){try{const w=await U(r,{db:f?.db,limit:100});if(w.empty)return{success:!1,message:`No docs to delete in ${r}`,jsonResponse:w.jsonResponse};const S=[];for(let E=0;E<w.docs?.length;E++){const A=w.docs[E].id;S.push(v(`${r}/${A}`,{db:f?.db}))}return await Promise.allSettled(S),{success:!0,message:`Successfully deleted ${w.docs?.length} docs in ${r}`,jsonResponse:w.jsonResponse}}catch(w){throw console.error("error in collection delete",w),new Error(`Error deleting docs in ${r}`)}}class p{r;constructor(r){this.databaseId=r;return this}doc(r){return new l(M(r),this.databaseId)}collection(r){return new n(M(r),this.databaseId)}}class l{r;f;constructor(r,f){this.docPath=r;this.databaseId=f}async update(r){return await L(this.docPath,r,{merge:!0,db:this.databaseId})}async set(r,f){return await L(this.docPath,r,{...f,db:this.databaseId})}async get(){return await D(this.docPath,{db:this.databaseId,debug:!1})}}class n{r;f;whereQueries;orderByQuery;limitQuery;pageQuery;constructor(r,f){this.collectionPath=r;this.databaseId=f;this.whereQueries=[],this.orderByQuery={field:"",direction:"ASCENDING"},this.limitQuery=100,this.pageQuery=1}where(r,f,w){return this.whereQueries.push({field:r,op:I(f),value:w}),this}orderBy(r,f){return this.orderByQuery={field:r,direction:Q(f)},this}limit(r){return this.limitQuery=r,this}async delete(){return await a(this.collectionPath,{db:this.databaseId})}page(r){return this.pageQuery=r,this}async tojson(){return await u(this.collectionPath,{db:this.databaseId})}async todocs(r){return await P(this.collectionPath,r,{db:this.databaseId})}async get(){let r;return r=await U(this.collectionPath,{where:this.whereQueries,orderBy:this.orderByQuery,limit:this.limitQuery,db:this.databaseId,page:this.pageQuery}),r}}class N{initialValue;constructor(r){return this.initialValue=r,this}async firestore(){const r=await h(this.initialValue);return new p(r.databaseId)}}function yr(r){return new N(r)}export{yr as initFirebaseRest,N as RestFirestoreInstance,p as FirestoreOperations};
